<!--
    Generated by JitBlox - rapid interactive prototyping of modern web apps from your browser.
    Upgrade to a Pro plan to remove this header, see https://www.jitblox.com/plans for more.
    
    Check out this JitBlox project, Soluce, at https://www.jitblox.com/project/5JHnGKTPaU/soluce
-->

<form [formGroup]="form" (ngSubmit)="onSubmit()" class="container py-3" role="form" novalidate>
  <div class="row g-3">
    <div class="col-12 col-md-6">
      <label for="pf-creator" class="form-label" i18n>Creator</label>
      <input id="pf-creator" type="text" class="form-control" formControlName="creatorCtrl" placeholder="Who created this?" i18n-placeholder readonly />
      @if (form.controls.creatorCtrl.touched && form.controls.creatorCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Creator is required (min 2 characters).</div>
      }
    </div>

    <div class="col-12">
      <label for="pf-name" class="form-label" i18n>Name</label>
      <input id="pf-name" type="text" class="form-control" formControlName="nameCtrl" placeholder="Problem title" i18n-placeholder [class.is-invalid]="form.controls.nameCtrl.touched && form.controls.nameCtrl.invalid" aria-required="true" [attr.aria-invalid]="form.controls.nameCtrl.invalid ? 'true' : 'false'" [attr.aria-describedby]="form.controls.nameCtrl.invalid ? 'nameError' : null" />
      @if (form.controls.nameCtrl.touched && form.controls.nameCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Name is required (min 3 characters).</div>
      }
    </div>

    <div class="col-12">
      <label for="pf-description" class="form-label" i18n>Description</label>
      <textarea id="pf-description" class="form-control" rows="4" formControlName="descriptionCtrl" placeholder="Describe the problem..." i18n-placeholder [class.is-invalid]="form.controls.descriptionCtrl.touched && form.controls.descriptionCtrl.invalid" aria-required="true" [attr.aria-invalid]="form.controls.descriptionCtrl.invalid ? 'true' : 'false'" [attr.aria-describedby]="form.controls.descriptionCtrl.invalid ? 'descError' : null"></textarea>
      @if (form.controls.descriptionCtrl.touched && form.controls.descriptionCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Description is required (min 5 characters).</div>
      }
    </div>

    <div class="col-12 col-md-4">
      <label for="pf-status" class="form-label" i18n>Status</label>
      <select id="pf-status" class="form-select" formControlName="statusCtrl" [class.is-invalid]="form.controls.statusCtrl.touched && form.controls.statusCtrl.invalid" aria-required="true" [attr.aria-invalid]="form.controls.statusCtrl.invalid ? 'true' : 'false'" [attr.aria-describedby]="form.controls.statusCtrl.invalid ? 'statusError' : null">
        <option [ngValue]="null" disabled i18n>Select status...</option>
        @for (s of statusOptions; track s) {
          <option [value]="s">{{ s }}</option>
        }
      </select>
      @if (form.controls.statusCtrl.touched && form.controls.statusCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Status is required.</div>
      }
    </div>

    <div class="col-12 col-md-4">
      <label for="pf-open" class="form-label" i18n>Visibility</label>
      <select id="pf-open" class="form-select" formControlName="visibilityCtrl" [attr.aria-invalid]="form.controls.visibilityCtrl.invalid ? 'true' : 'false'">
        @for (o of visibilityOptions; track o) {
          <option [value]="o">{{ o }}</option>
        }
      </select>
      
    </div>

    <div class="col-12 col-md-4">
      <label for="pf-date" class="form-label" i18n>Creation date</label>
      <input id="pf-date" type="date" class="form-control" formControlName="creationDateCtrl" readonly aria-readonly="true" aria-required="true" [attr.aria-invalid]="form.controls.creationDateCtrl.invalid ? 'true' : 'false'" />
      @if (form.controls.creationDateCtrl.touched && form.controls.creationDateCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Creation date is required.</div>
      }
    </div>
  </div>

  @if (showActions && !wizardMode) {
    <div class="d-flex gap-2 justify-content-end mt-4">
      <button type="button" class="btn btn-outline-secondary" (click)="onReset()" i18n>Reset</button>
      <button type="button" class="btn btn-outline-secondary" (click)="onCancel()" i18n>Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="form.invalid">{{ submitLabel }}</button>
    </div>
  }

  @if (wizardMode) {
    <div class="d-flex justify-content-between mt-4">
      <div class="small text-muted" i18n>Step: Problem details</div>
      <div class="small">
        <span [class.text-success]="form.valid" [class.text-danger]="form.invalid">
          @if (form.valid) {
            <span i18n>Ready to continue</span>
          } @else {
            <span i18n>Please complete required fields</span>
          }
        </span>
      </div>
    </div>
  }

  <!-- Group Authorizations Accordion Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="accordion" id="groupAuthAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button 
            class="accordion-button" 
            type="button" 
            [class.collapsed]="!groupAuthExpanded"
            (click)="groupAuthExpanded = !groupAuthExpanded"
            [attr.aria-expanded]="groupAuthExpanded"
            aria-controls="groupAuthCollapse"
            i18n>
            <i class="bi-people-fill me-2"></i>
            Group Authorizations
            @if (groupAuthorizations && groupAuthorizations.length > 0) {
              <span class="badge bg-primary ms-2">{{ groupAuthorizations.length }}</span>
            }
          </button>
        </h2>
        <div 
          id="groupAuthCollapse" 
          class="accordion-collapse collapse"
          [class.show]="groupAuthExpanded"
          data-bs-parent="#groupAuthAccordion">
          <div class="accordion-body">
            <div class="d-flex justify-content-end mb-3">
              <button 
                type="button" 
                class="btn btn-sm btn-primary" 
                (click)="onAddGroupAuthorization()"
                i18n>
                <i class="bi-plus-circle me-1"></i>
                Add Group
              </button>
            </div>
            
            @if (!groupAuthorizations || groupAuthorizations.length === 0) {
              <div class="text-center text-muted py-3" i18n>
                <i class="bi-inbox fs-4 d-block mb-2"></i>
                No groups assigned yet
              </div>
            } @else {
              <div class="list-group">
                @for (auth of groupAuthorizations; track auth.id || $index; let i = $index) {
                  <div class="list-group-item">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center gap-3 flex-grow-1">
                        <span 
                          class="badge rounded-pill d-inline-flex align-items-center gap-1 bg-light border">
                          <i [ngClass]="[getAuthorizationIcon(auth.authorizationLevel), getAuthorizationBadgeClass(auth.authorizationLevel)]"></i>
                          <span class="text-dark">{{ auth.group?.name || 'Unknown Group' }}</span>
                        </span>
                        @if (auth.group && auth.group.description) {
                          <div class="small text-muted flex-grow-1">{{ auth.group.description }}</div>
                        }
                      </div>
                      <button 
                        type="button"
                        class="btn btn-sm btn-outline-danger ms-2"
                        (click)="onRemoveGroupAuthorization(i)"
                        [attr.aria-label]="'Remove group ' + (auth.group?.name || '')"
                        i18n-aria-label>
                        <i class="bi-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</form>

<!-- Side Panel for Group Selection -->
@if (groupSelectionPanelOpen) {
  <!-- Backdrop -->
  <div 
    class="position-fixed top-0 start-0 w-100 h-100" 
    style="z-index: 1040; animation: fadeIn 0.2s ease-out; background-color: rgba(0, 0, 0, 0.5);"
    (click)="onCloseGroupSelectionPanel()">
  </div>
  
  <!-- Side Panel -->
  <div 
    class="position-fixed top-0 end-0 h-100 shadow-lg"
    style="width: 400px; max-width: 90vw; z-index: 1050; overflow-y: auto; animation: slideInRight 0.3s ease-out; background-color: var(--bs-body-bg, #fff); color: var(--bs-body-color, #212529);"
    (click)="$event.stopPropagation()">
    <div class="d-flex flex-column h-100">
      <!-- Panel Header -->
      <div class="border-bottom p-3" style="background-color: var(--bs-secondary-bg, #f8f9fa);">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0" i18n>
            <i class="bi-people-fill me-2"></i>
            Select Group
          </h5>
          <button 
            type="button" 
            class="btn-close" 
            (click)="onCloseGroupSelectionPanel()"
            aria-label="Close"
            i18n-aria-label>
          </button>
        </div>
        
        <!-- Search Input -->
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="groupSearchFilter"
            placeholder="Search groups..."
            i18n-placeholder
            autofocus>
        </div>
      </div>

      <!-- Panel Body -->
      <div class="flex-grow-1 p-3" style="overflow-y: auto;">
        @if (getAvailableGroupsForSelection().length === 0) {
          <div class="text-center text-muted py-5">
            <i class="bi-inbox fs-1 d-block mb-3"></i>
            @if (groupSearchFilter.trim() !== '') {
              <p i18n>No groups found matching your search</p>
            } @else {
              <p i18n>All available groups have been added</p>
            }
          </div>
        } @else {
          <div class="list-group">
            @for (group of getAvailableGroupsForSelection(); track group.id) {
              <div 
                class="list-group-item list-group-item-action cursor-pointer"
                [class.active]="selectedGroupForAdd?.id === group.id"
                (click)="onSelectGroup(group)"
                style="cursor: pointer;">
                <div class="d-flex w-100 justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="mb-1">{{ group.name || 'Unknown Group' }}</h6>
                    @if (group.description) {
                      <p class="mb-0 small text-muted">{{ group.description }}</p>
                    }
                  </div>
                  @if (selectedGroupForAdd?.id === group.id) {
                    <i class="bi-check-circle-fill text-primary ms-2"></i>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Panel Footer -->
      <div class="border-top p-3" style="background-color: var(--bs-secondary-bg, #f8f9fa);">
        <div class="mb-3">
          <label class="form-label small mb-2 d-block fw-semibold" i18n>Authorization Level</label>
          <div class="d-flex gap-2 w-100" role="group" aria-label="Authorization level selection">
            @for (level of authorizationLevels; track level; let i = $index) {
              <input 
                type="radio" 
                class="btn-check" 
                [id]="'auth-level-' + level"
                [value]="level"
                [(ngModel)]="selectedAuthLevelForAdd"
                name="authLevelRadio"
                autocomplete="off">
              <label 
                class="btn d-flex flex-column align-items-center justify-content-center gap-1"
                [style.flex]="'1 1 0'"
                [for]="'auth-level-' + level"
                [ngClass]="{
                  'btn-outline-danger': level === authorizationLevels[0],
                  'btn-outline-warning': level === authorizationLevels[1],
                  'btn-outline-info': level === authorizationLevels[2]
                }">
                <i [ngClass]="getAuthorizationIcon(level)" class="fs-5"></i>
                <span class="small fw-medium">{{ level }}</span>
              </label>
            }
          </div>
        </div>
        <div class="d-flex gap-2">
          <button 
            type="button" 
            class="btn btn-secondary flex-grow-1" 
            (click)="onCloseGroupSelectionPanel()"
            i18n>
            Close
          </button>
          <button 
            type="button" 
            class="btn btn-primary flex-grow-1" 
            (click)="onConfirmAddSelectedGroup()"
            [disabled]="selectedGroupForAdd === null"
            i18n>
            Add Selected
          </button>
        </div>
      </div>
    </div>
  </div>
}

<style>
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
