<!--
    Generated by JitBlox - rapid interactive prototyping of modern web apps from your browser.
    Upgrade to a Pro plan to remove this header, see https://www.jitblox.com/plans for more.
    
    Check out this JitBlox project, Soluce, at https://www.jitblox.com/project/5JHnGKTPaU/soluce
-->

<form [formGroup]="form" (ngSubmit)="onSubmit()" class="container py-3" role="form" novalidate>
  <div class="row g-3">
    <div class="col-12 col-md-6">
      <label for="pf-creator" class="form-label" i18n>Creator</label>
      <input id="pf-creator" type="text" class="form-control" formControlName="creatorCtrl" placeholder="Who created this?" i18n-placeholder readonly />
      @if (form.controls.creatorCtrl.touched && form.controls.creatorCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Creator is required (min 2 characters).</div>
      }
    </div>

    <div class="col-12">
      <label for="pf-name" class="form-label" i18n>Name</label>
      <input id="pf-name" type="text" class="form-control" formControlName="nameCtrl" placeholder="Problem title" i18n-placeholder [class.is-invalid]="form.controls.nameCtrl.touched && form.controls.nameCtrl.invalid" aria-required="true" [attr.aria-invalid]="form.controls.nameCtrl.invalid ? 'true' : 'false'" [attr.aria-describedby]="form.controls.nameCtrl.invalid ? 'nameError' : null" />
      @if (form.controls.nameCtrl.touched && form.controls.nameCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Name is required (min 3 characters).</div>
      }
    </div>

    <div class="col-12">
      <label for="pf-description" class="form-label" i18n>Description</label>
      <textarea id="pf-description" class="form-control" rows="4" formControlName="descriptionCtrl" placeholder="Describe the problem..." i18n-placeholder [class.is-invalid]="form.controls.descriptionCtrl.touched && form.controls.descriptionCtrl.invalid" aria-required="true" [attr.aria-invalid]="form.controls.descriptionCtrl.invalid ? 'true' : 'false'" [attr.aria-describedby]="form.controls.descriptionCtrl.invalid ? 'descError' : null"></textarea>
      @if (form.controls.descriptionCtrl.touched && form.controls.descriptionCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Description is required (min 5 characters).</div>
      }
    </div>

    <div class="col-12 col-md-4">
      <label for="pf-status" class="form-label" i18n>Status</label>
      <select id="pf-status" class="form-select" formControlName="statusCtrl" [class.is-invalid]="form.controls.statusCtrl.touched && form.controls.statusCtrl.invalid" aria-required="true" [attr.aria-invalid]="form.controls.statusCtrl.invalid ? 'true' : 'false'" [attr.aria-describedby]="form.controls.statusCtrl.invalid ? 'statusError' : null">
        <option [ngValue]="null" disabled i18n>Select status...</option>
        @for (s of statusOptions; track s) {
          <option [value]="s">{{ s }}</option>
        }
      </select>
      @if (form.controls.statusCtrl.touched && form.controls.statusCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Status is required.</div>
      }
    </div>

    <div class="col-12 col-md-4">
      <label for="pf-open" class="form-label" i18n>Visibility</label>
      <select id="pf-open" class="form-select" formControlName="visibilityCtrl" [attr.aria-invalid]="form.controls.visibilityCtrl.invalid ? 'true' : 'false'">
        @for (o of visibilityOptions; track o) {
          <option [value]="o">{{ o }}</option>
        }
      </select>
      
    </div>

    <div class="col-12 col-md-4">
      <label for="pf-date" class="form-label" i18n>Creation date</label>
      <input id="pf-date" type="date" class="form-control" formControlName="creationDateCtrl" readonly aria-readonly="true" aria-required="true" [attr.aria-invalid]="form.controls.creationDateCtrl.invalid ? 'true' : 'false'" />
      @if (form.controls.creationDateCtrl.touched && form.controls.creationDateCtrl.invalid) {
        <div class="text-danger small mt-1" i18n>Creation date is required.</div>
      }
    </div>
  </div>

  @if (showActions && !wizardMode) {
    <div class="d-flex gap-2 justify-content-end mt-4">
      <button type="button" class="btn btn-outline-secondary" (click)="onReset()" i18n>Reset</button>
      <button type="button" class="btn btn-outline-secondary" (click)="onCancel()" i18n>Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="form.invalid">{{ submitLabel }}</button>
    </div>
  }

  @if (wizardMode) {
    <div class="d-flex justify-content-between mt-4">
      <div class="small text-muted" i18n>Step: Problem details</div>
      <div class="small">
        <span [class.text-success]="form.valid" [class.text-danger]="form.invalid">
          @if (form.valid) {
            <span i18n>Ready to continue</span>
          } @else {
            <span i18n>Please complete required fields</span>
          }
        </span>
      </div>
    </div>
  }

  <!-- Group Authorizations Accordion Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="accordion" id="groupAuthAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button 
            class="accordion-button" 
            type="button" 
            [class.collapsed]="!groupAuthExpanded"
            (click)="groupAuthExpanded = !groupAuthExpanded"
            [attr.aria-expanded]="groupAuthExpanded"
            aria-controls="groupAuthCollapse"
            i18n>
            <i class="bi-people-fill me-2"></i>
            Group Authorizations
            @if (groupAuthorizations && groupAuthorizations.length > 0) {
              <span class="badge bg-primary ms-2">{{ groupAuthorizations.length }}</span>
            }
          </button>
        </h2>
        <div 
          id="groupAuthCollapse" 
          class="accordion-collapse collapse"
          [class.show]="groupAuthExpanded"
          data-bs-parent="#groupAuthAccordion">
          <div class="accordion-body">
            <div class="d-flex justify-content-end mb-3">
              <button 
                type="button" 
                class="btn btn-sm btn-primary" 
                (click)="onAddGroupAuthorization()"
                i18n>
                <i class="bi-plus-circle me-1"></i>
                Add Group
              </button>
            </div>
            
            @if (!groupAuthorizations || groupAuthorizations.length === 0) {
              <div class="text-center text-muted py-3" i18n>
                <i class="bi-inbox fs-4 d-block mb-2"></i>
                No groups assigned yet
              </div>
            } @else {
              <div class="list-group">
                @for (auth of groupAuthorizations; track auth.id || $index; let i = $index) {
                  <div class="list-group-item">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center gap-3 flex-grow-1">
                        <span 
                          class="badge rounded-pill d-inline-flex align-items-center gap-1 bg-light border">
                          <i [ngClass]="[getAuthorizationIcon(auth.authorizationLevel), getAuthorizationBadgeClass(auth.authorizationLevel)]"></i>
                          <span class="text-dark">{{ auth.group?.name || 'Unknown Group' }}</span>
                        </span>
                        @if (auth.group && auth.group.description) {
                          <div class="small text-muted flex-grow-1">{{ auth.group.description }}</div>
                        }
                      </div>
                      <button 
                        type="button"
                        class="btn btn-sm btn-outline-danger ms-2"
                        (click)="onRemoveGroupAuthorization(i)"
                        [attr.aria-label]="'Remove group ' + (auth.group?.name || '')"
                        i18n-aria-label>
                        <i class="bi-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</form>

<!-- Group Selection Panel Component -->
<app-group-selection-panel
  [availableGroups]="availableGroups"
  [excludedGroupIds]="getExcludedGroupIds()"
  [isOpen]="groupSelectionPanelOpen"
  (close)="onCloseGroupSelectionPanel()"
  (groupSelected)="onGroupSelected($event)">
</app-group-selection-panel>
